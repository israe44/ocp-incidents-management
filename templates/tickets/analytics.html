<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics - OCP Incidents</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-white">
  <header class="border-b border-white/10 bg-white/5">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Analytics Dashboard</h1>
        <p class="text-white/60 text-sm">Performance metrics and statistics</p>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-right">
          <div class="text-sm font-medium">{{ request.user.username }}</div>
          <div class="text-xs text-white/60">{{ request.user.role }}</div>
        </div>
        <a href="{% url 'dashboard' %}" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          Dashboard
        </a>
        <a href="{% url 'board' %}" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          Board
        </a>
        <a href="{% url 'export_tickets' %}" class="px-3 py-2 rounded-xl bg-green-600 hover:bg-green-500 border border-green-500 text-sm">
          ðŸ“Š Export CSV
        </a>
        <a href="{% url 'logout' %}" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          Logout
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-6">
    
    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
      <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
        <div class="text-white/60 text-xs mb-1">Total Tickets</div>
        <div class="text-2xl font-bold">{{ summary.total }}</div>
      </div>
      
      <div class="rounded-2xl bg-blue-600/20 border border-blue-500/30 p-4">
        <div class="text-blue-200 text-xs mb-1">New</div>
        <div class="text-2xl font-bold text-blue-300">{{ summary.new }}</div>
      </div>
      
      <div class="rounded-2xl bg-yellow-600/20 border border-yellow-500/30 p-4">
        <div class="text-yellow-200 text-xs mb-1">In Progress</div>
        <div class="text-2xl font-bold text-yellow-300">{{ summary.in_progress }}</div>
      </div>
      
      <div class="rounded-2xl bg-green-600/20 border border-green-500/30 p-4">
        <div class="text-green-200 text-xs mb-1">Resolved</div>
        <div class="text-2xl font-bold text-green-300">{{ summary.resolved }}</div>
      </div>
      
      <div class="rounded-2xl bg-gray-600/20 border border-gray-500/30 p-4">
        <div class="text-gray-200 text-xs mb-1">Closed</div>
        <div class="text-2xl font-bold text-gray-300">{{ summary.closed }}</div>
      </div>
      
      <div class="rounded-2xl bg-red-600/20 border border-red-500/30 p-4">
        <div class="text-red-200 text-xs mb-1">Critical</div>
        <div class="text-2xl font-bold text-red-300">{{ summary.critical }}</div>
      </div>
      
      <div class="rounded-2xl bg-orange-600/20 border border-orange-500/30 p-4">
        <div class="text-orange-200 text-xs mb-1">Overdue</div>
        <div class="text-2xl font-bold text-orange-300">{{ summary.overdue }}</div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- Status Distribution -->
      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-4">Status Distribution</h3>
        <canvas id="statusChart" class="max-h-64"></canvas>
      </div>

      <!-- Urgency Distribution -->
      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-4">Urgency Levels</h3>
        <canvas id="urgencyChart" class="max-h-64"></canvas>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- Category Distribution -->
      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-4">Tickets by Category</h3>
        <canvas id="categoryChart" class="max-h-64"></canvas>
      </div>

      <!-- Tickets Over Time -->
      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-4">Tickets Created (Last 30 Days)</h3>
        <canvas id="timelineChart" class="max-h-64"></canvas>
      </div>
    </div>

    <!-- Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-2">Average Resolution Time</h3>
        <div class="text-3xl font-bold text-blue-400">
          {% if avg_resolution_time %}
            {{ avg_resolution_time }} hours
          {% else %}
            N/A
          {% endif %}
        </div>
        <p class="text-white/60 text-sm mt-2">Time from creation to resolution</p>
      </div>

      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-2">Resolution Rate</h3>
        <div class="text-3xl font-bold text-green-400">
          {% widthratio summary.resolved summary.total 100 %}%
        </div>
        <p class="text-white/60 text-sm mt-2">Percentage of resolved tickets</p>
      </div>

      <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
        <h3 class="text-lg font-semibold mb-2">Open Tickets</h3>
        <div class="text-3xl font-bold text-yellow-400">
          {{ summary.new|add:summary.in_progress }}
        </div>
        <p class="text-white/60 text-sm mt-2">New + In Progress</p>
      </div>
    </div>

    {% if tech_stats %}
    <!-- Technician Performance -->
    <div class="rounded-2xl bg-white/5 border border-white/10 p-6 mb-4">
      <h3 class="text-lg font-semibold mb-4">Technician Performance</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-white/10">
              <th class="text-left py-2 px-3 text-sm font-medium text-white/70">Technician</th>
              <th class="text-left py-2 px-3 text-sm font-medium text-white/70">Speciality</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-white/70">Total</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-white/70">In Progress</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-white/70">Resolved</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-white/70">Resolution Rate</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in tech_stats %}
            <tr class="border-b border-white/5">
              <td class="py-3 px-3">{{ stat.technician.username }}</td>
              <td class="py-3 px-3 text-white/60">{{ stat.technician.speciality|default:"N/A" }}</td>
              <td class="py-3 px-3 text-center font-medium">{{ stat.total }}</td>
              <td class="py-3 px-3 text-center text-yellow-400">{{ stat.in_progress }}</td>
              <td class="py-3 px-3 text-center text-green-400">{{ stat.resolved }}</td>
              <td class="py-3 px-3 text-center">
                {% if stat.total > 0 %}
                  <span class="px-2 py-1 rounded-lg bg-green-600/20 text-green-300 text-sm">
                    {% widthratio stat.resolved stat.total 100 %}%
                  </span>
                {% else %}
                  <span class="text-white/40">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Recent Activity -->
    <div class="rounded-2xl bg-white/5 border border-white/10 p-6">
      <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
      <div class="space-y-3">
        {% for history in recent_history %}
        <div class="flex items-start gap-3 text-sm">
          <div class="text-white/40 text-xs mt-0.5">
            {{ history.created_at|date:"Y-m-d H:i" }}
          </div>
          <div class="flex-1">
            <span class="font-medium">{{ history.actor.username }}</span>
            <span class="text-white/60">{{ history.get_action_display|lower }}</span>
            <span class="text-white/60">on</span>
            <a href="{% url 'ticket_detail' history.ticket.id %}" class="text-blue-400 hover:text-blue-300">
              Ticket #{{ history.ticket.id }}
            </a>
            {% if history.note %}
            <span class="text-white/40">â€¢ {{ history.note }}</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

  </main>

<script>
  // Parse data from Django context
  const statusData = {{ status_stats|safe }};
  const urgencyData = {{ urgency_stats|safe }};
  const categoryData = {{ category_stats|safe }};
  const timelineData = {{ tickets_by_day|safe }};

  // Status Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: statusData.map(s => s.status),
      datasets: [{
        data: statusData.map(s => s.count),
        backgroundColor: ['#3b82f6', '#eab308', '#22c55e', '#6b7280'],
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#fff', padding: 15 }
        }
      }
    }
  });

  // Urgency Chart
  const urgencyCtx = document.getElementById('urgencyChart').getContext('2d');
  new Chart(urgencyCtx, {
    type: 'bar',
    data: {
      labels: urgencyData.map(s => s.urgency),
      datasets: [{
        label: 'Count',
        data: urgencyData.map(s => s.count),
        backgroundColor: ['#22c55e', '#eab308', '#f97316', '#ef4444'],
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { display: false }
        }
      }
    }
  });

  // Category Chart
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(categoryCtx, {
    type: 'pie',
    data: {
      labels: categoryData.map(s => s.category),
      datasets: [{
        data: categoryData.map(s => s.count),
        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6b7280'],
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#fff', padding: 10 }
        }
      }
    }
  });

  // Timeline Chart
  const timelineCtx = document.getElementById('timelineChart').getContext('2d');
  new Chart(timelineCtx, {
    type: 'line',
    data: {
      labels: timelineData.map(d => d.date),
      datasets: [{
        label: 'Tickets Created',
        data: timelineData.map(d => d.count),
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { display: false }
        }
      }
    }
  });
</script>

</body>
</html>

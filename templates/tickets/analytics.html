{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics - TicketFlow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50">
  <header class="border-b border-gray-200 bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="{% static 'images/image-1.png' %}" alt="OCP" class="h-10 w-auto" />
        <div>
          <h1 class="text-xl font-bold text-gray-900">Analytics Dashboard</h1>
          <p class="text-gray-500 text-sm">Performance metrics and statistics</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-right">
          <div class="text-sm font-medium text-gray-900">{{ request.user.username }}</div>
          <div class="text-xs text-gray-500">{{ request.user.role }}</div>
        </div>
        <a href="{% url 'dashboard' %}" class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 text-sm font-medium">
          Dashboard
        </a>
        <a href="{% url 'board' %}" class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 text-sm font-medium">
          Board
        </a>
        <a href="{% url 'export_tickets' %}" class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm font-medium">
          Export CSV
        </a>
        <a href="{% url 'logout' %}" class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 text-sm font-medium">
          Logout
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-6">
    
    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
      <div class="rounded-lg bg-white border border-gray-200 p-4">
        <div class="text-gray-600 text-xs font-medium mb-1">Total Tickets</div>
        <div class="text-2xl font-bold text-gray-900">{{ summary.total }}</div>
      </div>
      
      <div class="rounded-lg bg-blue-50 border border-blue-200 p-4">
        <div class="text-blue-700 text-xs font-medium mb-1">New</div>
        <div class="text-2xl font-bold text-blue-700">{{ summary.new }}</div>
      </div>
      
      <div class="rounded-lg bg-yellow-50 border border-yellow-200 p-4">
        <div class="text-yellow-700 text-xs font-medium mb-1">In Progress</div>
        <div class="text-2xl font-bold text-yellow-700">{{ summary.in_progress }}</div>
      </div>
      
      <div class="rounded-lg bg-green-50 border border-green-200 p-4">
        <div class="text-green-700 text-xs font-medium mb-1">Resolved</div>
        <div class="text-2xl font-bold text-green-700">{{ summary.resolved }}</div>
      </div>
      
      <div class="rounded-lg bg-gray-100 border border-gray-300 p-4">
        <div class="text-gray-700 text-xs font-medium mb-1">Closed</div>
        <div class="text-2xl font-bold text-gray-700">{{ summary.closed }}</div>
      </div>
      
      <div class="rounded-lg bg-red-50 border border-red-200 p-4">
        <div class="text-red-700 text-xs font-medium mb-1">Critical</div>
        <div class="text-2xl font-bold text-red-700">{{ summary.critical }}</div>
      </div>
      
      <div class="rounded-lg bg-orange-50 border border-orange-200 p-4">
        <div class="text-orange-700 text-xs font-medium mb-1">Overdue</div>
        <div class="text-2xl font-bold text-orange-700">{{ summary.overdue }}</div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- Status Distribution -->
      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Status Distribution</h3>
        <canvas id="statusChart" class="max-h-64"></canvas>
      </div>

      <!-- Urgency Distribution -->
      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Urgency Levels</h3>
        <canvas id="urgencyChart" class="max-h-64"></canvas>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- Category Distribution -->
      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tickets by Category</h3>
        <canvas id="categoryChart" class="max-h-64"></canvas>
      </div>

      <!-- Tickets Over Time -->
      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tickets Created (Last 30 Days)</h3>
        <canvas id="timelineChart" class="max-h-64"></canvas>
      </div>
    </div>

    <!-- Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Average Resolution Time</h3>
        <div class="text-3xl font-bold text-blue-600">
          {% if avg_resolution_time %}
            {{ avg_resolution_time }} hours
          {% else %}
            N/A
          {% endif %}
        </div>
        <p class="text-gray-600 text-sm mt-2">Time from creation to resolution</p>
      </div>

      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Resolution Rate</h3>
        <div class="text-3xl font-bold text-green-600">
          {% if summary.total > 0 %}
            {% widthratio summary.resolved summary.total 100 %}%
          {% else %}
            0%
          {% endif %}
        </div>
        <p class="text-gray-600 text-sm mt-2">Percentage of resolved tickets</p>
      </div>

      <div class="rounded-lg bg-white border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Open Tickets</h3>
        <div class="text-3xl font-bold text-yellow-600">
          {{ summary.new|add:summary.in_progress }}
        </div>
        <p class="text-gray-600 text-sm mt-2">New + In Progress</p>
      </div>
    </div>

    {% if tech_stats %}
    <!-- Technician Performance -->
    <div class="rounded-lg bg-white border border-gray-200 p-6 mb-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Technician Performance</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 px-3 text-sm font-medium text-gray-700">Technician</th>
              <th class="text-left py-2 px-3 text-sm font-medium text-gray-700">Speciality</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Total</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">In Progress</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Resolved</th>
              <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Resolution Rate</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in tech_stats %}
            <tr class="border-b border-gray-100">
              <td class="py-3 px-3 text-gray-900">{{ stat.technician.username }}</td>
              <td class="py-3 px-3 text-gray-600">{{ stat.technician.speciality|default:"N/A" }}</td>
              <td class="py-3 px-3 text-center font-medium text-gray-900">{{ stat.total }}</td>
              <td class="py-3 px-3 text-center text-yellow-700 font-medium">{{ stat.in_progress }}</td>
              <td class="py-3 px-3 text-center text-green-700 font-medium">{{ stat.resolved }}</td>
              <td class="py-3 px-3 text-center">
                {% if stat.total > 0 %}
                  <span class="px-2 py-1 rounded-lg bg-green-100 text-green-700 text-sm font-medium">
                    {% widthratio stat.resolved stat.total 100 %}%
                  </span>
                {% else %}
                  <span class="text-gray-400">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Recent Activity -->
    <div class="rounded-lg bg-white border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
      <div class="space-y-3">
        {% for history in recent_history %}
        <div class="flex items-start gap-3 text-sm">
          <div class="text-gray-500 text-xs mt-0.5">
            {{ history.created_at|date:"Y-m-d H:i" }}
          </div>
          <div class="flex-1 text-gray-700">
            <span class="font-medium text-gray-900">{{ history.actor.username }}</span>
            <span>{{ history.get_action_display|lower }}</span>
            <span>on</span>
            <a href="{% url 'ticket_detail' history.ticket.id %}" class="text-green-700 hover:text-green-800 font-medium">
              Ticket #{{ history.ticket.id }}
            </a>
            {% if history.note %}
            <span class="text-white/40">â€¢ {{ history.note }}</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

  </main>

<script>
  // Parse data from Django context
  const statusData = JSON.parse('{{ status_stats_json|escapejs }}');
  const urgencyData = JSON.parse('{{ urgency_stats_json|escapejs }}');
  const categoryData = JSON.parse('{{ category_stats_json|escapejs }}');
  const timelineData = JSON.parse('{{ tickets_by_day_json|escapejs }}');

  // Color maps for cards
  const statusColorMap = {
    'NEW': '#3b82f6',
    'IN_PROGRESS': '#eab308',
    'RESOLVED': '#22c55e',
    'CLOSED': '#6b7280',
  };
  const urgencyColorMap = {
    'LOW': '#6b7280',
    'MEDIUM': '#eab308',
    'HIGH': '#f97316',
    'CRITICAL': '#ef4444',
  };

  // Status Chart
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusData.map(s => s.status),
      datasets: [{
        data: statusData.map(s => s.count),
        backgroundColor: statusData.map(s => statusColorMap[s.status] || '#d1d5db'),
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Urgency Chart
  new Chart(document.getElementById('urgencyChart'), {
    type: 'pie',
    data: {
      labels: urgencyData.map(u => u.urgency),
      datasets: [{
        data: urgencyData.map(u => u.count),
        backgroundColor: urgencyData.map(u => urgencyColorMap[u.urgency] || '#d1d5db'),
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Category Chart
  new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
      labels: categoryData.map(c => c.category),
      datasets: [{
        label: 'Tickets',
        data: categoryData.map(c => c.count),
        backgroundColor: '#3b82f6',
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  // Timeline Chart
  new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
      labels: timelineData.map(t => t.date),
      datasets: [{
        label: 'Tickets Created',
        data: timelineData.map(t => t.count),
        backgroundColor: '#3b82f6',
        borderColor: '#3b82f6',
        fill: false,
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Common chart colors
  const chartColors = {
    blue: '#3b82f6',
    yellow: '#eab308',
    green: '#22c55e',
    gray: '#6b7280',
    red: '#ef4444',
    orange: '#f97316',
    purple: '#8b5cf6',
    pink: '#ec4899'
  };

  // Check if data exists
  if (statusData && statusData.length > 0) {
    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
      type: 'doughnut',
      data: {
        labels: statusData.map(s => s.status),
        datasets: [{
          data: statusData.map(s => s.count),
          backgroundColor: [chartColors.blue, chartColors.yellow, chartColors.green, chartColors.gray],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { 
              color: '#374151',
              padding: 15,
              font: { size: 12, weight: '500' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 }
          }
        }
      }
    });
  } else {
    document.getElementById('statusChart').parentElement.innerHTML += '<p class="text-gray-500 text-sm text-center">No data available</p>';
  }

  // Urgency Chart
  if (urgencyData && urgencyData.length > 0) {
    const urgencyCtx = document.getElementById('urgencyChart').getContext('2d');
    new Chart(urgencyCtx, {
      type: 'bar',
      data: {
        labels: urgencyData.map(s => s.urgency),
        datasets: [{
          label: 'Tickets',
          data: urgencyData.map(s => s.count),
          backgroundColor: [chartColors.gray, chartColors.yellow, chartColors.orange, chartColors.red],
          borderWidth: 1,
          borderColor: 'rgba(0,0,0,0.1)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#374151',
              font: { size: 11, weight: '500' },
              precision: 0
            },
            grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false }
          },
          x: {
            ticks: { 
              color: '#374151',
              font: { size: 11, weight: '500' }
            },
            grid: { display: false }
          }
        }
      }
    });
  } else {
    document.getElementById('urgencyChart').parentElement.innerHTML += '<p class="text-gray-500 text-sm text-center">No data available</p>';
  }

  // Category Chart
  if (categoryData && categoryData.length > 0) {
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
      type: 'pie',
      data: {
        labels: categoryData.map(s => s.category),
        datasets: [{
          data: categoryData.map(s => s.count),
          backgroundColor: [
            chartColors.blue, chartColors.purple, chartColors.pink, 
            chartColors.orange, chartColors.green, chartColors.gray
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { 
              color: '#374151',
              padding: 10,
              font: { size: 11, weight: '500' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12
          }
        }
      }
    });
  } else {
    document.getElementById('categoryChart').parentElement.innerHTML += '<p class="text-gray-500 text-sm text-center">No data available</p>';
  }

  // Timeline Chart
  if (timelineData && timelineData.length > 0) {
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: timelineData.map(d => {
          const date = new Date(d.date);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
          label: 'Tickets Created',
          data: timelineData.map(d => d.count),
          borderColor: chartColors.blue,
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: chartColors.blue,
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            displayColors: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#374151',
              font: { size: 11, weight: '500' },
              precision: 0
            },
            grid: { 
              color: 'rgba(0,0,0,0.05)',
              drawBorder: false
            }
          },
          x: {
            ticks: { 
              color: '#374151',
              font: { size: 10, weight: '500' },
              maxRotation: 45,
              minRotation: 45
            },
            grid: { display: false }
          }
        }
      }
    });
  } else {
    document.getElementById('timelineChart').parentElement.innerHTML += '<p class="text-gray-500 text-sm text-center">No data available</p>';
  }
</script>

</body>
</html>

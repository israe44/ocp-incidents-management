<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket #{{ ticket.id }} - OCP Incidents</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-white">
  <header class="border-b border-white/10 bg-white/5">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Ticket #{{ ticket.id }}</h1>
        <p class="text-white/60 text-sm">{{ ticket.title }}</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="{% url 'dashboard' %}" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          Back
        </a>
        <a href="{% url 'logout' %}" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">
          Logout
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Ticket info -->
    <section class="lg:col-span-2 space-y-4">
      <div class="rounded-2xl bg-white/5 border border-white/10 p-5">
        <div class="flex flex-wrap items-center gap-2 justify-between">
          <div class="text-sm text-white/60">
            Created by <span class="text-white">{{ ticket.created_by.username }}</span>
            · {{ ticket.created_at|date:"Y-m-d H:i" }}
          </div>

          <div class="flex gap-2 text-xs">
            <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/10">Urgency: <b>{{ ticket.urgency }}</b></span>
            <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/10">Status: <b>{{ ticket.status }}</b></span>
          </div>
        </div>

        <div class="mt-4">
          <h3 class="font-semibold mb-1">Description</h3>
          <p class="text-white/80 whitespace-pre-line">{{ ticket.description }}</p>
        </div>

        <div class="mt-4 text-sm text-white/60">
          Assigned to:
          <span class="text-white">
            {% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}—{% endif %}
          </span>

          {% if request.user.role == "technician" and not ticket.assigned_to %}
            <form method="POST" action="{% url 'ticket_take' ticket.id %}" class="mt-2">
              {% csrf_token %}
              <button class="px-3 py-2 rounded-xl bg-green-600 hover:bg-green-500 text-sm">
                Take this ticket
              </button>
            </form>
          {% endif %}
        </div>
      </div>

      <!-- Comments -->
      <div class="rounded-2xl bg-white/5 border border-white/10 p-5">
        <h3 class="font-semibold mb-3">Comments</h3>

        <div class="space-y-3">
          {% for c in ticket.comments.all %}
            <div class="rounded-xl bg-slate-900/60 border border-white/10 p-3">
              <div class="text-sm font-medium">{{ c.author.username }}
                <span class="text-xs text-white/50 font-normal">· {{ c.created_at|date:"Y-m-d H:i" }}</span>
              </div>
              <div class="text-white/80 mt-1 whitespace-pre-line">{{ c.content }}</div>
            </div>
          {% empty %}
            <div class="text-white/60 text-sm">No comments yet.</div>
          {% endfor %}
        </div>

        <form method="POST" action="{% url 'ticket_comment' ticket.id %}" class="mt-4 space-y-2">
          {% csrf_token %}
          <textarea name="content" rows="3" required
                    class="w-full rounded-xl bg-slate-900 border border-white/10 px-4 py-2 outline-none focus:border-blue-500"
                    placeholder="Write a comment..."></textarea>
          <button class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-sm font-medium">
            Add comment
          </button>
        </form>
      </div>
    </section>

    <!-- Right: Actions + History -->
    <aside class="space-y-4">

      <!-- Admin assign -->
      {% if request.user.role == "admin" %}
      <div class="rounded-2xl bg-white/5 border border-white/10 p-5">
        <h3 class="font-semibold mb-3">Assign to technician</h3>
        <form method="POST" action="{% url 'ticket_assign' ticket.id %}" class="space-y-3">
          {% csrf_token %}
          <select name="technician_id"
                  class="w-full rounded-xl bg-slate-900 border border-white/10 px-4 py-2 outline-none focus:border-blue-500">
            {% for tech in technicians %}
              <option value="{{ tech.id }}">{{ tech.username }}{% if tech.speciality %} — {{ tech.speciality }}{% endif %}</option>
            {% endfor %}
          </select>
          <button class="w-full px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-medium">
            Assign
          </button>
        </form>
      </div>
      {% endif %}

      <!-- Status change -->
      {% if request.user.role == "admin" or request.user.role == "technician" %}
      <div class="rounded-2xl bg-white/5 border border-white/10 p-5">
        <h3 class="font-semibold mb-3">Update status</h3>
        <form method="POST" action="{% url 'ticket_status' ticket.id %}" class="space-y-3">
          {% csrf_token %}
          <select name="status"
                  class="w-full rounded-xl bg-slate-900 border border-white/10 px-4 py-2 outline-none focus:border-blue-500">
            <option value="NEW" {% if ticket.status == "NEW" %}selected{% endif %}>NEW</option>
            <option value="IN_PROGRESS" {% if ticket.status == "IN_PROGRESS" %}selected{% endif %}>IN_PROGRESS</option>
            <option value="RESOLVED" {% if ticket.status == "RESOLVED" %}selected{% endif %}>RESOLVED</option>
            <option value="CLOSED" {% if ticket.status == "CLOSED" %}selected{% endif %}>CLOSED</option>
          </select>
          <button class="w-full px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-medium">
            Save
          </button>
        </form>
      </div>
      {% endif %}

      <!-- History -->
      <div class="rounded-2xl bg-white/5 border border-white/10 p-5">
        <h3 class="font-semibold mb-3">History</h3>
        <div class="space-y-2 text-sm">
          {% for h in ticket.history.all %}
            <div class="rounded-xl bg-slate-900/60 border border-white/10 p-3">
              <div class="font-medium">{{ h.action }}</div>
              <div class="text-white/60 text-xs">
                by {{ h.actor.username }} · {{ h.created_at|date:"Y-m-d H:i" }}
                {% if h.from_status or h.to_status %}
                  · {{ h.from_status }} → {{ h.to_status }}
                {% endif %}
              </div>
              {% if h.note %}
                <div class="text-white/70 mt-1">{{ h.note }}</div>
              {% endif %}
            </div>
          {% empty %}
            <div class="text-white/60 text-sm">No history yet.</div>
          {% endfor %}
        </div>
      </div>

    </aside>
  </main>
</body>
</html>
